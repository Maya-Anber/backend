<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/backend/assets/theme.css">
  <style>
    #messages{height:60vh; overflow:auto; background:var(--surface-2); border:1px solid var(--border); border-radius:10px; padding:12px}
    .msg{margin-bottom:10px}
    .msg.me{ text-align:right }
    .msg .bubble{display:inline-block; padding:8px 12px; border-radius:14px; max-width:70%}
    .msg.me .bubble{ background:var(--primary-700); color:#fff }
    .msg.other .bubble{ background:#aaabaf; color:var(--text) }
    .meta{font-size:11px; color:var(--muted); margin-top:2px}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="../list/index.php">ðŸ“š Book Exchange</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="nav" data-dyn-nav>
        <!-- dynamic nav -->
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <div id="alert" class="alert d-none" role="alert"></div>
    <h3 id="title" class="mb-3">Chat</h3>
    <div id="messages" class="mb-3"></div>
    <form id="sendForm" class="d-flex gap-2">
      <input type="text" id="message" class="form-control" placeholder="Type a message" required>
      <button class="btn btn-primary" type="submit">Send</button>
    </form>
  </div>

  <footer class="bg-dark text-white text-center py-3 mt-5">Â© 2025 Book Exchange</footer>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/nav.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const exchangeId = Number(params.get('exchange_request_id'));
    if(!exchangeId){ document.getElementById('alert').className='alert alert-danger'; document.getElementById('alert').textContent='Missing exchange_request_id'; }

    function banner(msg,type='info'){ const el=document.getElementById('alert'); el.className='alert alert-'+type; el.textContent=msg; }
    function clearBanner(){ const el=document.getElementById('alert'); el.className='alert d-none'; el.textContent=''; }

    let exchangeStatus = undefined;
    function setSendEnabled(enabled, reason){
      const form = document.getElementById('sendForm');
      const input = document.getElementById('message');
      const btn = form.querySelector('button[type="submit"]');
      input.disabled = !enabled;
      btn.disabled = !enabled;
      if(!enabled && reason){ banner(reason, 'warning'); }
      if(enabled){ clearBanner(); }
    }

    function fetchStatus(){
      // use conversations list to get current status for this exchange
      return fetch('list_conversations.php', { credentials:'same-origin' })
        .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
        .then(rows=>{
          if(Array.isArray(rows)){
            const row = rows.find(x => Number(x.request_id) === exchangeId);
            if(row){
              exchangeStatus = (row.status||'').toLowerCase();
              // update title with status badge
              const title = document.getElementById('title');
              if(title && !title.querySelector('.badge')){
                const badge = document.createElement('span');
                badge.className = 'badge bg-secondary ms-2';
                badge.textContent = row.status;
                title.appendChild(badge);
              }
              if(exchangeStatus === 'rejected' || exchangeStatus === 'cancelled'){
                setSendEnabled(false, 'Messaging is disabled for '+exchangeStatus+' requests.');
              } else {
                setSendEnabled(true);
              }
            }
          }
        })
        .catch(()=>{/* ignore, keep defaults */});
    }

  function fetchMessages(){
      fetch('get_messages.php?exchange_request_id='+encodeURIComponent(exchangeId), { credentials:'same-origin' })
        .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
        .then(list=>{
          const wrap = document.getElementById('messages');
          wrap.innerHTML = '';
          if(!Array.isArray(list)) { banner('Unexpected response','danger'); return; }
          list.forEach(msg=>{
            const div = document.createElement('div');
            const me = (window.__ME && Number(window.__ME) === Number(msg.sender_id));
            div.className = 'msg ' + (me ? 'me' : 'other');
            div.innerHTML = '<div class="bubble">'+ (msg.message_content||'') +'</div>'
                           + '<div class="meta">'+ (msg.sender_username||msg.sender_id) +' â€¢ '+ msg.sent_date + (msg.is_read? ' â€¢ Read':'' ) + '</div>';
            wrap.appendChild(div);
          });
          wrap.scrollTop = wrap.scrollHeight;
          // mark read
          fetch('mark_read.php', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ exchange_request_id: exchangeId }), credentials:'same-origin' });
      // also refresh status in case it changed
      fetchStatus();
        })
        .catch(err=>banner('Failed to load: '+err.message,'danger'));
    }

    document.getElementById('sendForm').addEventListener('submit', function(e){
      e.preventDefault();
      clearBanner();
      const input = document.getElementById('message');
      const txt = input.value.trim();
      if(!txt) return;
      fetch('send_message.php', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ exchange_request_id: exchangeId, message: txt }), credentials:'same-origin' })
        .then(r=>r.json().catch(()=>({success:false,error:'Invalid JSON'})))
        .then(res=>{
          if(res && res.success){ input.value=''; fetchMessages(); }
          else banner(res.error||'Failed to send','danger');
        })
        .catch(err=>banner('Failed to send: '+err.message,'danger'));
    });

  // initial & poll
  fetchStatus().finally(fetchMessages);
    setInterval(fetchMessages, 5000);
  </script>
</body>
</html>
